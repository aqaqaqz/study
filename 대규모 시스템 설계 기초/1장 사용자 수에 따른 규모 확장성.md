# 사용자 수에 따른 규모 확장성
##### 사용자 요청 처리 흐름
    - DNS에 질의하여 ip획득 -> 해당 ip로 HTTP요청 -> 응답
##### 웹서버, 웹어플리케이션서버
- 웹서버
    - 정적인 컨텐츠(사진, html 등)
-어플리케이션서버
    - 동적인 컨텐츠(데이터처리, 비즈니스로직 등)
##### 서버
- 단일서버
    - 모든 컴포넌트가 하나의 서버에서 실행
    - 웹, 앱, 데이터베이스, 캐시 등
- DB
    - 유저가 늘어남에 따라 DB서버를 따로 둔다
    - 관계형 데이터베이스(RDBMS)
        - ORACLE, MySQL, PostgreSQL 등
    - 비관계형 데이터베이스(NoSQL)
        - 키-값 저장소
        - 그래프 저장소
        - 칼럼 저장소
        - 문서 저장소
    - 비관계형 데이터베이스가 필요한 경우
        - 아주 낮은 응답 지연시간
        - 비정형 데이터인 경우(형식이 없는 데이터)
        - 데이터를 직렬화 혹은 역직렬화만 가능하면 됨
        - 데이터의 양이 많음
- 서버의 규모 확장
    - 스케일업(수직적 규모 확장)
        - 서버에 고사양의 자원 투입(CPU, RAM 등)
    - 스케일아웃(수평적 규모 확장)
        - 서버의 숫자를 추가
    - 트래픽의 양이 적은 경우는 수직적 확장이 유리(단순)
    - 스케일업의 단점 때문에 규모가 커질수록 스케일아웃이 적절하다
        - CPU나 RAM 등 무한대 증설은 불가능
        - 서버 장애시 답없음
- 로드밸런서
    - 부하 분산 집합에 속한 웹 서버의 트래픽을 고르게 분산
    - 사용자는 로드밸런서의 공개 IP주소로 접속
        - 서버간 통신에는 사설 IP주소를 사용
- 데이터베이스 다중화
    - 보통 주-부 관계를 설정하고 원본은 주, 사본은 부
    - 쓰기는 주에서만 가능. 부는 사본을 전달받고 읽기를 지원
- 캐시
    - 연산 코스트가 높거나 자주 사용되는 데이터를 메모리에서 꺼내쓰는 저장소
    - DB의 부하 감소
    - 사용시 유의해야 할 점
        - 바람직한 상황 : 갱신은 적고 참조는 많은 경우
        - 휘발성 메모리기 때문에 영속적 보관이 필요한 경우는 x
        - 캐시 데이터의 만료 정책이 필요
        - 일관성 유지 방법
        - SPOF(단일 장애 지점)의 고려(캐시 서버의 분산 필요)
        - 메모리의 용량 고려
        - 데이터 방출 정책의 고민(LRU, LFU, FIFO 등)
- 컨텐츠 전송 네트워크(CDN)
    - 이미지, 비디오, js파일 등 정적인 컨텐츠의 요청 처리
    - CDN의 동작 순서
        - 요청
        - CDN서버에 없는 경우 원본 서버에 요청
        - CDN서버에 응답시엔 TTL(Time To Live)값이 필요
        - 이후 동일 데이터는 CDN서버에서 응답
    - 주의점
        - 데이터 양에 따라 비용발생. 불필요한 데이터는 사용 x
        - 적절한 만료 시간
        - CDN이 죽은 경우 원본 서버로 요청도 필요
        - 기존 컨텐츠의 무효화 방법
        - 대부분의 주의점은 캐시에도 적용된다
- 무상태 웹 계층
    - 세션에 있는 상태정보(유저정보 등)는 어디서나 동일해야 함
    - 로드밸런서가 고정세션을 지원하지만 부담이 간다
    - 이런 데이터를 지속성 저장소에 보관하는데 이곳을 무상태 웹계층이라 한다
- 메시지 큐
    - 보관된 메시지는 꺼내기 전까지 무손실을 보장(비동기 컴포넌트)
    - 이용시 결합이 느슨해져서 확정성이 보장되어야 하는 구성에 유리하다
    - ex) 이미지 보정 어플(생산자와 소비자의 독립적 확장 가능)
        ~~~
        생산자(웹 서버) ---> 작업큐 ---> 소비자(보정 작업)
        ~~~
- 로그, 메트릭, 자동화
    - 로그는 서버단위보단 단일 서비스로 모아주는 도구를 활용하면 더 좋다
    - 메트릭 수집
        - 호스트 단위 메트릭 : CPU, 메모리, DISK I/O 등
        - 종합 메트릭 : DB, 캐시 등의 성능
        - 핵심 비즈니스 메트릭 : 일별 사용자, 수익, 재방문 등
    - 자동화 : 빌드, 테스트, 배포 등의 자동화
- 데이터베이스의 규모 확장
    - 수직적 확장(스케일 업)
        - 스택옹버플로는 2013년 한 해 사용자를 한대로 처리했다
        - 성능업의 한계 존재
        - SPOF(단일 장애 지점)의 위험 존재
        - 비싸다
    - 수평적 확장(샤딩)
        - 데이터베이스를 샤드라 부르는 작은 단위로 분할하는 기술
        - 모든 샤드의 스키마는 동일하지만 데이터의 중복은 없다
        - 샤딩 키(파티션 키)의 정의 방법이 중요하다
    - 샤딩 도입 시 해결해야 할 문제점들
        - 데이터의 재 샤딩(너무 많아졌거나 분포가 고르지 못한 경우)
        - 유명인사 문제(핫스팟 키) : 특정 샤드에 과부하가 걸리는 경우
        - 조인과 비정규화 : 샤드 서버로 쪼개면 조인이 힘들다
- 정리
    - 웹 계층은 무상태 계층으로
    - 모든 계층에 다중화 도입
    - 가능한 많은 데이터를 캐시할 것
    - 데이터 센터의 지원
    - 정적 콘텐츠는 CDN을 통해 서비스
    - 데이터 계층은 샤딩을 통해 확장할 것
    - 각 계층은 독립적 서비스로 분할

